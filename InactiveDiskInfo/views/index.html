<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inactive Disk Info</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.css" rel="stylesheet">
  <style>
    body {
	font-size: 1.1rem;
    }
    h1 {
	font-size: 1.75rem;
    }
    .noUi-tooltip {
	font-size: 1.1rem;
	opacity: 0.6;
    }
    table th, table td {
	font-size: 1.1rem;
	vertical-align: middle;
	white-space: nowrap;
	padding-left: 1.2rem !important;
	padding-right: 1.2rem !important;
    }
    td.text-end {
	text-align: right;
    }
  </style>
</head>
<body class="container mt-4">
<h1 class="mb-2">Inactive Disk Info</h1>

<p class="lead mb-5 text-muted">
  This application visualizes disk usage activity over time. Filter by period, count, size, or user to identify inactive or large datasets.
</p>

<div class="row gx-5 mb-2">
  <div class="col-md-3">
    <div class="mb-4">
      <label for="dataset-select" class="form-label"><strong>Select Dataset:</strong></label>
      <select id="dataset-select" class="form-select form-select-sm w-100"></select>
    </div>
    <div class="mb-4">
      <label for="group-select" class="form-label"><strong>Filter by Group:</strong></label>
      <select id="group-select" class="form-select form-select-sm w-100"></select>
    </div>
    <div class="mb-4">
      <label for="user-select" class="form-label"><strong>Filter by User:</strong></label>
      <select id="user-select" class="form-select form-select-sm w-100"></select>
    </div>
  </div>

  <div class="col-md-6">
    <div class="mb-4">
      <label class="form-label"><strong>Inactive Period:</strong></label>
      <div id="period-slider" class="slider-narrow"></div>
    </div>
    <div class="mb-4">
      <label class="form-label"><strong>Count:</strong></label>
      <div id="count-slider" class="slider-narrow"></div>
    </div>
    <div class="mb-4">
      <label class="form-label"><strong>Size (TiB):</strong></label>
      <div id="size-slider" class="slider-narrow"></div>
    </div>
    <div>
      <button id="reset-parameters" class="btn btn-sm btn-outline-secondary w-100">Reset Parameters</button>
    </div>
  </div>
</div>

<div style="margin-bottom: 3px;">
  <strong>MEMO:</strong>
  <ul>
    <li>If you want to find files that haven't been accessed for more than N days, use "<code>find /path/to/dir -type f -mtime +N</code>" in Terminal <i class="bi bi-terminal-fill" style="color: black;"></i>.</li>
    <li>The information is updated approximately once a month.</li>
  </ul>
</div>

<div class="table-responsive">
  <table class="table table-bordered table-striped table-sm w-auto">
    <thead class="table-light">
      <tr id="tableHead"><th></th></tr>
    </thead>
    <tbody id="tableBody">
      <tr><td>Loading data...</td></tr>
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.js"></script>
<script>
  const periodList = ["02w", "01m", "02m", "03m", "06m", "12m", "18m", "24m", "36m", "48m", "49m"];
  const periodLabels = {
      "02w": "0 - 2 weeks",
      "01m": "2 weeks - 1 month",
      "02m": "1 - 2 months",
      "03m": "2 - 3 months",
      "06m": "3 - 6 months",
      "12m": "6 - 12 months",
      "18m": "12 - 18 months",
      "24m": "18 - 24 months",
      "36m": "24 - 36 months",
      "48m": "36 - 48 months",
      "49m": "48 months+"
  };
  const countRanges = [ [1, 10_000], [10_000, 100_000], [100_000, 1_000_000], [1_000_000, 10_000_000], [10_000_000, 100_000_000], [100_000_000, Infinity] ];
  const sizeRanges = [ [0, 0.01], [0.01, 0.1], [0.1, 1], [1, 10], [10, 100], [100, Infinity] ];
  const sizeLabels = ["0 - 0.01", "0.01 – 0.1", "0.1 – 1", "1 – 10", "10 – 100", "100+"];
  const countLabels = ["1 – 10k", "10k – 100k", "100k – 1M", "1M – 10M", "10M – 100M", "100M+"];
  
  const defaultPeriodRange = [6, 10]; // 18m – 49m
  const defaultCountRange = [3, 5];   // 10M – 100M+
  const defaultSizeRange = [3, 5];    // 1 – 100
  const defaultUser = 'ALL';
  
  let currentPeriodRange = defaultPeriodRange;
  let currentCountRange = defaultCountRange;
  let currentSizeRange = defaultSizeRange;
  
  let allData = [];
  let keys = [];
  const column_count = 7;
  const ood_url = "https://ondemand.fugaku.r-ccs.riken.jp"

  // Converts an epoch timestamp (in seconds) to a formatted UTC date-time string.
  function epochToUTC(epochSeconds) {
      const date = new Date(Number(epochSeconds) * 1000);
      return date.toISOString().replace('T', ' ').split('.')[0];
  }

  // Render the table based on the current filter conditions.
  function renderTableWithFilters(selectedPeriods, countMin, countMax, sizeMin, sizeMax) {
      const selectedUser = document.getElementById('user-select').value;
      const selectedGroup = document.getElementById('group-select').value;
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      
      const filtered = allData.filter(row => {
	  const count = parseInt(row.count, 10);
	  const size = parseFloat(row.size);
	  return (
	      row.count !== "0" &&
		  selectedPeriods.includes(row.Period) &&
		  (selectedUser === 'ALL' || row.usr === selectedUser) &&
		  (selectedGroup === 'ALL' || row.grp === selectedGroup) &&
		  !isNaN(count) && count >= countMin && count < countMax &&
		  !isNaN(size) && size >= sizeMin && size < sizeMax
	  );
      });
      
      if (filtered.length === 0) {
          tableBody.innerHTML = `<tr><td colspan=${column_count}>No matching data.</td></tr>`;
          return;
      }

      // Sort the filtered rows by the order of Period defined in periodList.
      // This ensures the table shows data from shortest to longest inactive periods.
      filtered.sort((a, b) => {
          return periodList.indexOf(a.Period) - periodList.indexOf(b.Period);
      });
      
      filtered.forEach(row => {
          const tr = document.createElement('tr');
          keys.forEach(key => {
	      const td = document.createElement('td');
	      if (key === "dt") {
		  td.textContent = epochToUTC(row[key]);
	      } else if (key === "path") {
		  const paths = row[key].split(',').map(p => p.trim());
		  paths.forEach((path, index) => {
		      // Link of Home Directory on Open OnDemand
		      const HomeDirectoryLink = document.createElement('a');
		      HomeDirectoryLink.href = `${ood_url}/pun/sys/dashboard/files/fs/${path}`;
		      HomeDirectoryLink.textContent = path;
		      HomeDirectoryLink.target = "_blank";
		      HomeDirectoryLink.rel = "noopener noreferrer";
		      td.appendChild(HomeDirectoryLink);
		      
		      // Add &nbsp;
		      td.appendChild(document.createTextNode('\u00A0'));
		      
		      // Link of Terminal on Open OnDemand
		      const terminalLink = document.createElement('a');
		      terminalLink.href = `${ood_url}/pun/sys/shell/ssh/login/${path}`;
		      terminalLink.innerHTML = '<i class="bi bi-terminal-fill" style="color: black;"></i>';
		      terminalLink.target = "_blank";
		      terminalLink.rel = "noopener noreferrer";
		      td.appendChild(terminalLink);
		      
		      // Add a line break after each path except the last one.
		      if (index < paths.length - 1) {
		    	  td.appendChild(document.createElement('br'));
		      }
		  });
	      } else if (key === "Period") {
		  td.textContent = periodLabels[row[key]];
		  td.classList.add('text-center');
	      } else if (key === "count") {
		  td.textContent = Number(row[key]).toLocaleString();
		  td.classList.add('text-end');
	      } else if (key === "size") {
		  td.textContent = row[key];
		  td.classList.add('text-end'); 
	      } else { // "usr" and "grp"
		  td.textContent = row[key];
	      }
	      tr.appendChild(td);
          });
          tableBody.appendChild(tr);
      });
  }

  // Collect current slider and dropdown selections, and triggers a filtered table render.
  function triggerTableRender() {
      const periodSlider = document.getElementById('period-slider').noUiSlider;
      const countSlider = document.getElementById('count-slider').noUiSlider;
      const sizeSlider = document.getElementById('size-slider').noUiSlider;
      
      if (!periodSlider || !countSlider || !sizeSlider) return;
      
      currentPeriodRange = periodSlider.get().map(Number);
      currentCountRange = countSlider.get().map(Number);
      currentSizeRange = sizeSlider.get().map(Number);
      
      const selectedPeriods = periodList.slice(currentPeriodRange[0], currentPeriodRange[1] + 1);
      const countMin = countRanges[currentCountRange[0]][0];
      const countMax = countRanges[currentCountRange[1]][1];
      const sizeMin = sizeRanges[currentSizeRange[0]][0];
      const sizeMax = sizeRanges[currentSizeRange[1]][1];

      renderTableWithFilters(selectedPeriods, countMin, countMax, sizeMin, sizeMax);
  }

  // Populate a generic <select> element with options.
  function populateSelect(selectId, values) {
      const select = document.getElementById(selectId);
      select.innerHTML = '';

      const allOption = document.createElement('option');
      allOption.value = 'ALL';
      allOption.textContent = '(ALL)';
      select.appendChild(allOption);
      
      values.forEach(value => {
	  const opt = document.createElement('option');
	  opt.value = value;
	  opt.textContent = value;
	  select.appendChild(opt);
      });
      
      select.addEventListener('change', triggerTableRender);
  }

  // Initialize the period range slider using noUiSlider.
  function setupPeriodSlider() {
      const sliderElem = document.getElementById('period-slider');
      if (sliderElem.noUiSlider) sliderElem.noUiSlider.destroy();
      
      noUiSlider.create(sliderElem, {
	  start: currentPeriodRange,
	  connect: true,
	  step: 1,
	  range: {
	      min: 0,
	      max: periodList.length - 1
	  },
	  tooltips: [
	      {
		  to: index => periodLabels[periodList[Math.round(index)]],
                  from: label => periodList.find(key => periodLabels[key] === label)
	      },
	      {
		  to: index => periodLabels[periodList[Math.round(index)]],
                  from: label => periodList.find(key => periodLabels[key] === label)
	      }
	  ],
	  format: {
	      to: value => Math.round(value),
	      from: value => Number(value)
	  }
      });
      
      sliderElem.noUiSlider.on('update', triggerTableRender);
  }

  // Initialize the count range slider using noUiSlider.
  function setupCountSlider() {
      const sliderElem = document.getElementById('count-slider');
      if (sliderElem.noUiSlider) sliderElem.noUiSlider.destroy();
      
      noUiSlider.create(sliderElem, {
	  start: currentCountRange,
	  connect: true,
	  step: 1,
	  range: {
	      min: 0,
	      max: countRanges.length - 1
	  },
	  tooltips: [
	      {
		  to: index => countLabels[Math.round(index)],
		  from: label => countLabels.indexOf(label)
	      },
	      {
		  to: index => countLabels[Math.round(index)],
		  from: label => countLabels.indexOf(label)
	      }
	  ],
	  format: {
	      to: value => Math.round(value),
	      from: value => Number(value)
	  }
      });
      
      sliderElem.noUiSlider.on('update', triggerTableRender);
  }

  // Initialize the size range slider using noUiSlider.
  function setupSizeSlider() {
      const sliderElem = document.getElementById('size-slider');
      if (sliderElem.noUiSlider) sliderElem.noUiSlider.destroy();

      noUiSlider.create(sliderElem, {
          start: currentSizeRange,
          connect: true,
          step: 1,
          range: {
              min: 0,
              max: sizeRanges.length - 1
          },
          tooltips: [
              {
                  to: index => sizeLabels[Math.round(index)],
                  from: label => sizeLabels.indexOf(label)
              },
              {
                  to: index => sizeLabels[Math.round(index)],
                  from: label => sizeLabels.indexOf(label)
              }
          ],
          format: {
              to: value => Math.round(value),
              from: value => Number(value)
          }
        });

      sliderElem.noUiSlider.on('update', triggerTableRender);
  }

  // Fetch the list of available dataset files from the server
  // and populate the dataset dropdown menu (#dataset-select).
  function populateDatasetSelect() {
      document.getElementById('tableHead').innerHTML = '';
      fetch(`${location.pathname.replace(/\/$/, '')}/api/list`)
	  .then(res => res.json())
	  .then(files => {
	      const select = document.getElementById('dataset-select');
	      select.innerHTML = '';
	      
	      files.forEach(file => {
		  const opt = document.createElement('option');
		  opt.value = file;
		  opt.textContent = file;
		  select.appendChild(opt);
	      });
	      
	      select.addEventListener('change', (e) => {
		  loadData(e.target.value);
	      });

	      // Read initial selection
	      if (files.length > 0) {
		  loadData(files[0]);
	      }
	  })
	  .catch(err => {
	      console.error("Failed to load dataset list:", err);
	  });
  }

  // Load dataset JSON file by name and updates the table and UI accordingly.
  function loadData(group) {
      fetch(`${location.pathname.replace(/\/$/, '')}/api/${group}.json`)
	  .then(res => res.json())
	  .then(data => {
	      allData = data.filter(row => row.count !== "0");
	      if (allData.length === 0) {
		  document.getElementById('tableBody').innerHTML =
		      `<tr><td>No data available.</td></tr>`;
		  return;
	      }
	      
	      keys = Object.keys(allData[0]).filter(key => key !== 'mdt' && key !== 'vol');
	      // keys = ["dt", "path", "grp", "usr", "Period", "count", "size"]
		
	      const tableHead = document.getElementById('tableHead');
	      tableHead.innerHTML = '';
	      keys.forEach(key => {
		  const th = document.createElement('th');
		  th.textContent =
		      key === "dt" ? "Date (UTC)" :
		      key === "path" ? "Path" :
		      key === "usr" ? "User" :
		      key === "grp" ? "Group" :
		      key === "Period" ? "Inactive Period" :
		      key === "count" ? "Count" :
		      key === "size" ? "Size (TiB)" :
		      key;
		  tableHead.appendChild(th);
	      });
		
	      const uniqueUsers = [...new Set(allData.map(row => row.usr))].sort();
	      populateSelect('user-select', uniqueUsers);
	      const uniqueGroups = [...new Set(allData.map(row => row.grp))].sort();
	      populateSelect('group-select', uniqueGroups);

	      document.getElementById('tableBody').innerHTML = `<tr><td colspan=${column_count}>Loading data...</td></tr>`;
	      // Delay slider initialization until the browser renders "Loading data...".
	      // Calling requestAnimationFrame twice ensures the following order: DOM changes -> screen rendering -> script execution.
	      // This is because the drawing function (.on('update', render)) is run within setup[Period|Count|Size]Slider().
	      requestAnimationFrame(() => {
		  requestAnimationFrame(() => {
		      setupPeriodSlider();
		      setupCountSlider();
		      setupSizeSlider();
		  });
	      });
	  })
	  .catch(err => {
	      document.getElementById('tableBody').innerHTML =
		  '<tr><td colspan="99">Error loading data: ' + err.message + '</td></tr>';
	  });
  }
  
  populateDatasetSelect();
  document.getElementById('reset-parameters').addEventListener('click', () => {
      // Values of sliders are reset.
      const periodSlider = document.getElementById('period-slider')?.noUiSlider;
      const countSlider = document.getElementById('count-slider')?.noUiSlider;
      const sizeSlider = document.getElementById('size-slider')?.noUiSlider;
      
      if (periodSlider) periodSlider.set(defaultPeriodRange);
      if (countSlider) countSlider.set(defaultCountRange);
      if (sizeSlider) sizeSlider.set(defaultSizeRange);
      
      triggerTableRender();
  });
  </script>
</body>
</html>
